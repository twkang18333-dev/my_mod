using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using TaleWorlds.Core;
using TaleWorlds.Engine;
using TaleWorlds.Library;
using TaleWorlds.MountAndBlade.AI;

namespace TaleWorlds.MountAndBlade.Missions.Handlers
{
	// Token: 0x020003E7 RID: 999
	public class SiegeDeploymentHandler : BattleDeploymentHandler
	{
		// Token: 0x170009FA RID: 2554
		// (get) Token: 0x060036DC RID: 14044 RVA: 0x000E22F4 File Offset: 0x000E04F4
		// (set) Token: 0x060036DD RID: 14045 RVA: 0x000E22FC File Offset: 0x000E04FC
		public IEnumerable<DeploymentPoint> PlayerDeploymentPoints { get; private set; }

		// Token: 0x170009FB RID: 2555
		// (get) Token: 0x060036DE RID: 14046 RVA: 0x000E2305 File Offset: 0x000E0505
		// (set) Token: 0x060036DF RID: 14047 RVA: 0x000E230D File Offset: 0x000E050D
		public IEnumerable<DeploymentPoint> AllDeploymentPoints { get; private set; }

		// Token: 0x060036E0 RID: 14048 RVA: 0x000E2316 File Offset: 0x000E0516
		public SiegeDeploymentHandler(bool isPlayerAttacker) : base(isPlayerAttacker)
		{
		}

		// Token: 0x060036E1 RID: 14049 RVA: 0x000E2320 File Offset: 0x000E0520
		public override void OnBehaviorInitialize()
		{
			base.OnBehaviorInitialize();
			MissionSiegeEnginesLogic missionBehavior = base.Mission.GetMissionBehavior<MissionSiegeEnginesLogic>();
			this._defenderSiegeWeaponsController = missionBehavior.GetSiegeWeaponsController(BattleSideEnum.Defender);
			this._attackerSiegeWeaponsController = missionBehavior.GetSiegeWeaponsController(BattleSideEnum.Attacker);
			this._defenderReferencePosition = WorldPosition.Invalid;
		}

		// Token: 0x060036E2 RID: 14050 RVA: 0x000E2364 File Offset: 0x000E0564
		public override void OnRemoveBehavior()
		{
			base.OnRemoveBehavior();
			base.Mission.IsFormationUnitPositionAvailable_AdditionalCondition -= this.Mission_IsFormationUnitPositionAvailable_AdditionalCondition;
		}

		// Token: 0x060036E3 RID: 14051 RVA: 0x000E2384 File Offset: 0x000E0584
		public override void AfterStart()
		{
			base.AfterStart();
			this.AllDeploymentPoints = Mission.Current.ActiveMissionObjects.FindAllWithType<DeploymentPoint>();
			this.PlayerDeploymentPoints = from dp in this.AllDeploymentPoints
			where dp.Side == base.PlayerTeam.Side
			select dp;
			foreach (DeploymentPoint deploymentPoint in this.AllDeploymentPoints)
			{
				deploymentPoint.OnDeploymentStateChanged += this.OnDeploymentStateChange;
			}
			base.Mission.IsFormationUnitPositionAvailable_AdditionalCondition += this.Mission_IsFormationUnitPositionAvailable_AdditionalCondition;
		}

		// Token: 0x060036E4 RID: 14052 RVA: 0x000E242C File Offset: 0x000E062C
		public override void FinishDeployment()
		{
			foreach (DeploymentPoint deploymentPoint in this.AllDeploymentPoints)
			{
				deploymentPoint.OnDeploymentStateChanged -= this.OnDeploymentStateChange;
			}
			base.FinishDeployment();
		}

		// Token: 0x060036E5 RID: 14053 RVA: 0x000E2488 File Offset: 0x000E0688
		public void DeployAllSiegeWeaponsOfPlayer()
		{
			BattleSideEnum side = this.IsPlayerAttacker ? BattleSideEnum.Attacker : BattleSideEnum.Defender;
			new SiegeWeaponAutoDeployer((from dp in base.Mission.ActiveMissionObjects.FindAllWithType<DeploymentPoint>()
			where dp.Side == side
			select dp).ToList<DeploymentPoint>(), this.GetWeaponsControllerOfSide(side)).DeployAll(side);
		}

		// Token: 0x060036E6 RID: 14054 RVA: 0x000E24EF File Offset: 0x000E06EF
		public int GetMaxDeployableWeaponCountOfPlayer(Type weapon)
		{
			return this.GetWeaponsControllerOfSide(this.IsPlayerAttacker ? BattleSideEnum.Attacker : BattleSideEnum.Defender).GetMaxDeployableWeaponCount(weapon);
		}

		// Token: 0x060036E7 RID: 14055 RVA: 0x000E250C File Offset: 0x000E070C
		public void DeployAllSiegeWeaponsOfAi()
		{
			BattleSideEnum side = this.IsPlayerAttacker ? BattleSideEnum.Defender : BattleSideEnum.Attacker;
			new SiegeWeaponAutoDeployer((from dp in base.Mission.ActiveMissionObjects.FindAllWithType<DeploymentPoint>()
			where dp.Side == side
			select dp).ToList<DeploymentPoint>(), this.GetWeaponsControllerOfSide(side)).DeployAll(side);
			this.RemoveDeploymentPoints(side);
		}

		// Token: 0x060036E8 RID: 14056 RVA: 0x000E2580 File Offset: 0x000E0780
		public void RemoveDeploymentPoints(BattleSideEnum side)
		{
			IEnumerable<DeploymentPoint> source = base.Mission.ActiveMissionObjects.FindAllWithType<DeploymentPoint>();
			Func<DeploymentPoint, bool> <>9__0;
			Func<DeploymentPoint, bool> predicate;
			if ((predicate = <>9__0) == null)
			{
				predicate = (<>9__0 = ((DeploymentPoint dp) => dp.Side == side));
			}
			foreach (DeploymentPoint deploymentPoint in source.Where(predicate).ToArray<DeploymentPoint>())
			{
				foreach (SynchedMissionObject synchedMissionObject in deploymentPoint.DeployableWeapons.ToArray<SynchedMissionObject>())
				{
					if (deploymentPoint.DeployedWeapon == null || !synchedMissionObject.GameEntity.IsVisibleIncludeParents())
					{
						SiegeWeapon siegeWeapon = synchedMissionObject as SiegeWeapon;
						if (siegeWeapon != null)
						{
							siegeWeapon.SetDisabledSynched();
						}
					}
				}
				deploymentPoint.SetDisabledSynched();
			}
		}

		// Token: 0x060036E9 RID: 14057 RVA: 0x000E2648 File Offset: 0x000E0848
		public void RemoveUnavailableDeploymentPoints(BattleSideEnum side)
		{
			IMissionSiegeWeaponsController weapons = (side == BattleSideEnum.Defender) ? this._defenderSiegeWeaponsController : this._attackerSiegeWeaponsController;
			IEnumerable<DeploymentPoint> source = base.Mission.ActiveMissionObjects.FindAllWithType<DeploymentPoint>();
			Func<DeploymentPoint, bool> <>9__0;
			Func<DeploymentPoint, bool> predicate;
			if ((predicate = <>9__0) == null)
			{
				predicate = (<>9__0 = ((DeploymentPoint dp) => dp.Side == side));
			}
			Func<Type, bool> <>9__1;
			foreach (DeploymentPoint deploymentPoint in source.Where(predicate).ToArray<DeploymentPoint>())
			{
				IEnumerable<Type> deployableWeaponTypes = deploymentPoint.DeployableWeaponTypes;
				Func<Type, bool> predicate2;
				if ((predicate2 = <>9__1) == null)
				{
					predicate2 = (<>9__1 = ((Type wt) => weapons.GetMaxDeployableWeaponCount(wt) > 0));
				}
				if (!deployableWeaponTypes.Any(predicate2))
				{
					foreach (SiegeWeapon siegeWeapon in from sw in deploymentPoint.DeployableWeapons
					select sw as SiegeWeapon)
					{
						siegeWeapon.SetDisabledSynched();
					}
					deploymentPoint.SetDisabledSynched();
				}
			}
		}

		// Token: 0x060036EA RID: 14058 RVA: 0x000E2770 File Offset: 0x000E0970
		public void UnHideDeploymentPoints(BattleSideEnum side)
		{
			IEnumerable<DeploymentPoint> source = base.Mission.ActiveMissionObjects.FindAllWithType<DeploymentPoint>();
			Func<DeploymentPoint, bool> <>9__0;
			Func<DeploymentPoint, bool> predicate;
			if ((predicate = <>9__0) == null)
			{
				predicate = (<>9__0 = ((DeploymentPoint dp) => !dp.IsDisabled && dp.Side == side));
			}
			foreach (DeploymentPoint deploymentPoint in source.Where(predicate))
			{
				deploymentPoint.Show();
			}
		}

		// Token: 0x060036EB RID: 14059 RVA: 0x000E27F8 File Offset: 0x000E09F8
		public int GetDeployableWeaponCountOfPlayer(Type weapon)
		{
			return this.GetWeaponsControllerOfSide(this.IsPlayerAttacker ? BattleSideEnum.Attacker : BattleSideEnum.Defender).GetMaxDeployableWeaponCount(weapon) - this.PlayerDeploymentPoints.Count((DeploymentPoint dp) => dp.IsDeployed && MissionSiegeWeaponsController.GetWeaponType(dp.DeployedWeapon) == weapon);
		}

		// Token: 0x060036EC RID: 14060 RVA: 0x000E2848 File Offset: 0x000E0A48
		public void AutoDeployTeamUsingTeamAI(Team team, bool autoAssignDetachments = true)
		{
			List<Formation> list = team.FormationsIncludingEmpty.ToList<Formation>();
			bool allowAiTicking = base.Mission.AllowAiTicking;
			bool forceTickOccasionally = base.Mission.ForceTickOccasionally;
			bool isTeleportingAgents = base.Mission.IsTeleportingAgents;
			base.Mission.AllowAiTicking = true;
			base.Mission.ForceTickOccasionally = true;
			base.Mission.IsTeleportingAgents = true;
			OrderController orderController = team.IsPlayerTeam ? team.PlayerOrderController : team.MasterOrderController;
			orderController.SelectAllFormations(false);
			base.SetDefaultFormationOrders(orderController);
			team.ResetTactic();
			team.Tick(0f);
			foreach (Formation formation in list)
			{
				formation.ApplyActionOnEachUnit(delegate(Agent agent)
				{
					agent.ForceUpdateCachedAndFormationValues(false, false);
				}, null);
				formation.SetHasPendingUnitPositions(false);
			}
			orderController.ClearSelectedFormations();
			if (autoAssignDetachments)
			{
				this.AutoAssignDetachmentsForDeployment(team);
			}
			base.Mission.IsTeleportingAgents = isTeleportingAgents;
			base.Mission.ForceTickOccasionally = forceTickOccasionally;
			base.Mission.AllowAiTicking = allowAiTicking;
		}

		// Token: 0x060036ED RID: 14061 RVA: 0x000E2978 File Offset: 0x000E0B78
		public void AutoAssignDetachmentsForDeployment(Team team)
		{
			List<Formation> list = team.FormationsIncludingEmpty.ToList<Formation>();
			bool allowAiTicking = base.Mission.AllowAiTicking;
			bool isTeleportingAgents = base.Mission.IsTeleportingAgents;
			base.Mission.AllowAiTicking = true;
			base.Mission.IsTeleportingAgents = true;
			if (!team.DetachmentManager.Detachments.IsEmpty<ValueTuple<IDetachment, DetachmentData>>())
			{
				using (List<Formation>.Enumerator enumerator = list.GetEnumerator())
				{
					while (enumerator.MoveNext())
					{
						enumerator.Current.ApplyActionOnEachUnit(delegate(Agent agent)
						{
							Formation formation2 = agent.Formation;
							if (formation2 == null)
							{
								return;
							}
							formation2.Team.DetachmentManager.TickAgent(agent);
						}, null);
					}
				}
				int num = 0;
				int num2 = 0;
				foreach (ValueTuple<IDetachment, DetachmentData> valueTuple in team.DetachmentManager.Detachments)
				{
					num += valueTuple.Item1.GetNumberOfUsableSlots();
				}
				foreach (Formation formation in team.FormationsIncludingEmpty)
				{
					num2 += formation.CountOfDetachableNonPlayerUnits;
				}
				for (int i = 0; i < MathF.Min(num, num2); i++)
				{
					team.DetachmentManager.TickDetachments();
				}
				using (List<Formation>.Enumerator enumerator = list.GetEnumerator())
				{
					while (enumerator.MoveNext())
					{
						enumerator.Current.ApplyActionOnEachUnit(delegate(Agent agent)
						{
							if (agent.Detachment != null && !(agent.Detachment is UsableMachine))
							{
								agent.ForceUpdateCachedAndFormationValues(false, false);
							}
						}, null);
					}
				}
			}
			base.Mission.IsTeleportingAgents = isTeleportingAgents;
			base.Mission.AllowAiTicking = allowAiTicking;
		}

		// Token: 0x060036EE RID: 14062 RVA: 0x000E2B6C File Offset: 0x000E0D6C
		protected bool Mission_IsFormationUnitPositionAvailable_AdditionalCondition(WorldPosition position, Team team)
		{
			if (team != null && team.Side == BattleSideEnum.Defender)
			{
				Scene scene = base.Mission.Scene;
				if (!this._defenderReferencePosition.IsValid)
				{
					WeakGameEntity weakGameEntity = scene.FindWeakEntityWithTag("defender_infantry");
					this._defenderReferencePosition = new WorldPosition(scene, UIntPtr.Zero, weakGameEntity.GlobalPosition, false);
				}
				return scene.DoesPathExistBetweenPositions(this._defenderReferencePosition, position);
			}
			return true;
		}

		// Token: 0x060036EF RID: 14063 RVA: 0x000E2BD4 File Offset: 0x000E0DD4
		private void OnDeploymentStateChange(DeploymentPoint deploymentPoint, SynchedMissionObject targetObject)
		{
			if (!deploymentPoint.IsDeployed && base.PlayerTeam.DetachmentManager.ContainsDetachment(deploymentPoint.DisbandedWeapon as IDetachment))
			{
				base.PlayerTeam.DetachmentManager.DestroyDetachment(deploymentPoint.DisbandedWeapon as IDetachment);
			}
			SiegeWeapon missionWeapon;
			if ((missionWeapon = (targetObject as SiegeWeapon)) != null)
			{
				IMissionSiegeWeaponsController weaponsControllerOfSide = this.GetWeaponsControllerOfSide(deploymentPoint.Side);
				if (deploymentPoint.IsDeployed)
				{
					weaponsControllerOfSide.OnWeaponDeployed(missionWeapon);
					return;
				}
				weaponsControllerOfSide.OnWeaponUndeployed(missionWeapon);
			}
		}

		// Token: 0x060036F0 RID: 14064 RVA: 0x000E2C4F File Offset: 0x000E0E4F
		private IMissionSiegeWeaponsController GetWeaponsControllerOfSide(BattleSideEnum side)
		{
			if (side != BattleSideEnum.Defender)
			{
				return this._attackerSiegeWeaponsController;
			}
			return this._defenderSiegeWeaponsController;
		}

		// Token: 0x060036F1 RID: 14065 RVA: 0x000E2C64 File Offset: 0x000E0E64
		public Vec2 GetEstimatedAverageDefenderPosition()
		{
			WorldPosition worldPosition;
			Vec2 vec;
			base.Mission.GetFormationSpawnFrame(Mission.Current.DefenderTeam, FormationClass.Infantry, false, out worldPosition, out vec);
			return worldPosition.AsVec2;
		}

		// Token: 0x060036F2 RID: 14066 RVA: 0x000E2C94 File Offset: 0x000E0E94
		[Conditional("DEBUG")]
		private void AssertSiegeWeapons(IEnumerable<DeploymentPoint> allDeploymentPoints)
		{
			HashSet<SynchedMissionObject> hashSet = new HashSet<SynchedMissionObject>();
			foreach (SynchedMissionObject item in allDeploymentPoints.SelectMany((DeploymentPoint amo) => amo.DeployableWeapons))
			{
				if (!hashSet.Add(item))
				{
					break;
				}
			}
		}

		// Token: 0x04001796 RID: 6038
		private IMissionSiegeWeaponsController _defenderSiegeWeaponsController;

		// Token: 0x04001797 RID: 6039
		private IMissionSiegeWeaponsController _attackerSiegeWeaponsController;

		// Token: 0x04001798 RID: 6040
		private WorldPosition _defenderReferencePosition;
	}
}
