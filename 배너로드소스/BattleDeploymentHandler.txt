using System;
using System.Collections.Generic;
using System.Linq;
using TaleWorlds.Core;
using TaleWorlds.Engine;
using TaleWorlds.Library;

namespace TaleWorlds.MountAndBlade.Missions.Handlers
{
	// Token: 0x020003E6 RID: 998
	public class BattleDeploymentHandler : DeploymentHandler
	{
		// Token: 0x060036D5 RID: 14037 RVA: 0x000E1FAE File Offset: 0x000E01AE
		public BattleDeploymentHandler(bool isPlayerAttacker) : base(isPlayerAttacker)
		{
		}

		// Token: 0x060036D6 RID: 14038 RVA: 0x000E1FB7 File Offset: 0x000E01B7
		public override void OnRemoveBehavior()
		{
			base.OnRemoveBehavior();
			if (base.PlayerTeam != null)
			{
				base.PlayerTeam.OnOrderIssued -= this.OrderController_OnOrderIssued;
			}
		}

		// Token: 0x060036D7 RID: 14039 RVA: 0x000E1FDE File Offset: 0x000E01DE
		public override void AfterStart()
		{
			base.AfterStart();
			base.PlayerTeam.OnOrderIssued += this.OrderController_OnOrderIssued;
		}

		// Token: 0x060036D8 RID: 14040 RVA: 0x000E2000 File Offset: 0x000E0200
		public override void AutoDeployTeamUsingDeploymentPlan(Team team)
		{
			List<Formation> list = team.FormationsIncludingEmpty.ToList<Formation>();
			if (list.Count > 0)
			{
				bool isTeleportingAgents = base.Mission.IsTeleportingAgents;
				base.Mission.IsTeleportingAgents = true;
				OrderController orderController = team.IsPlayerTeam ? team.PlayerOrderController : team.MasterOrderController;
				orderController.SelectAllFormations(false);
				this.SetDefaultFormationOrders(orderController);
				orderController.ClearSelectedFormations();
				IMissionDeploymentPlan deploymentPlan = base.Mission.DeploymentPlan;
				if (deploymentPlan.IsPlanMade(team))
				{
					using (List<Formation>.Enumerator enumerator = list.GetEnumerator())
					{
						while (enumerator.MoveNext())
						{
							Formation formation = enumerator.Current;
							IFormationDeploymentPlan formationPlan = deploymentPlan.GetFormationPlan(team, formation.FormationIndex, false);
							WorldPosition worldPosition;
							Vec2 vec;
							base.Mission.GetFormationSpawnFrame(formation.Team, formation.FormationIndex, false, out worldPosition, out vec);
							if (formationPlan.HasDimensions)
							{
								formation.SetFormOrder(FormOrder.FormOrderCustom(formationPlan.PlannedWidth), true);
							}
							formation.SetMovementOrder(MovementOrder.MovementOrderMove(worldPosition));
							formation.SetFacingOrder(FacingOrder.FacingOrderLookAtDirection(vec));
							formation.SetPositioning(new WorldPosition?(worldPosition), new Vec2?(vec), new int?(formation.ArrangementOrder.GetUnitSpacing()));
							formation.ApplyActionOnEachUnit(delegate(Agent agent)
							{
								agent.ForceUpdateCachedAndFormationValues(true, false);
							}, null);
							formation.SetHasPendingUnitPositions(false);
							formation.SetMovementOrder(MovementOrder.MovementOrderStop);
						}
						goto IL_188;
					}
				}
				Debug.FailedAssert("Failed to deploy team. Initial deployment plan is not made yet.", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.MountAndBlade\\Missions\\MissionLogics\\BattleDeploymentHandler.cs", "AutoDeployTeamUsingDeploymentPlan", 84);
				IL_188:
				foreach (Formation formation2 in list)
				{
					formation2.ApplyActionOnEachUnit(delegate(Agent agent)
					{
						agent.ForceUpdateCachedAndFormationValues(true, false);
					}, null);
					formation2.SetHasPendingUnitPositions(false);
				}
				if (team.GeneralAgent != null)
				{
					WorldPosition position;
					Vec2 direction;
					base.Mission.GetFormationSpawnFrame(team, FormationClass.NumberOfRegularFormations, false, out position, out direction);
					if (position.GetNavMesh() != UIntPtr.Zero && position.IsValid)
					{
						team.GeneralAgent.SetFormationFrameEnabled(position, direction, Vec2.Zero, 0f);
					}
				}
				base.Mission.IsTeleportingAgents = isTeleportingAgents;
			}
		}

		// Token: 0x060036D9 RID: 14041 RVA: 0x000E2264 File Offset: 0x000E0464
		public override void ForceUpdateAllUnits()
		{
			DeploymentHandler.OrderController_OnOrderIssued_Aux(OrderType.Move, base.PlayerTeam.FormationsIncludingSpecialAndEmpty, null, Array.Empty<object>());
		}

		// Token: 0x060036DA RID: 14042 RVA: 0x000E2280 File Offset: 0x000E0480
		public void SetDefaultFormationOrders(OrderController orderController)
		{
			orderController.SetOrder(OrderType.AIControlOff);
			orderController.SetFormationUpdateEnabledAfterSetOrder(false);
			orderController.SetOrder(OrderType.Mount);
			orderController.SetOrder(OrderType.FireAtWill);
			orderController.SetOrder(OrderType.ArrangementLine);
			orderController.SetOrder(OrderType.StandYourGround);
			orderController.SetOrder((base.Mission.IsSiegeBattle || base.Mission.IsSallyOutBattle) ? OrderType.AIControlOn : OrderType.AIControlOff);
			orderController.SetFormationUpdateEnabledAfterSetOrder(true);
		}

		// Token: 0x060036DB RID: 14043 RVA: 0x000E22E8 File Offset: 0x000E04E8
		private void OrderController_OnOrderIssued(OrderType orderType, MBReadOnlyList<Formation> appliedFormations, OrderController orderController, params object[] delegateParams)
		{
			DeploymentHandler.OrderController_OnOrderIssued_Aux(orderType, appliedFormations, orderController, delegateParams);
		}
	}
}
