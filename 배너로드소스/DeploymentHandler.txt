using System;
using System.Collections.Generic;
using System.Runtime.CompilerServices;
using TaleWorlds.Core;
using TaleWorlds.Engine;
using TaleWorlds.Library;

namespace TaleWorlds.MountAndBlade
{
	// Token: 0x0200027F RID: 639
	public abstract class DeploymentHandler : MissionLogic
	{
		// Token: 0x14000035 RID: 53
		// (add) Token: 0x06002391 RID: 9105 RVA: 0x0007E914 File Offset: 0x0007CB14
		// (remove) Token: 0x06002392 RID: 9106 RVA: 0x0007E94C File Offset: 0x0007CB4C
		public event Action OnPlayerSideDeploymentReady;

		// Token: 0x14000036 RID: 54
		// (add) Token: 0x06002393 RID: 9107 RVA: 0x0007E984 File Offset: 0x0007CB84
		// (remove) Token: 0x06002394 RID: 9108 RVA: 0x0007E9BC File Offset: 0x0007CBBC
		public event Action OnEnemySideDeploymentReady;

		// Token: 0x17000709 RID: 1801
		// (get) Token: 0x06002395 RID: 9109 RVA: 0x0007E9F1 File Offset: 0x0007CBF1
		public Team PlayerTeam
		{
			get
			{
				return base.Mission.PlayerTeam;
			}
		}

		// Token: 0x06002396 RID: 9110 RVA: 0x0007E9FE File Offset: 0x0007CBFE
		public DeploymentHandler(bool isPlayerAttacker)
		{
			this.IsPlayerAttacker = isPlayerAttacker;
		}

		// Token: 0x06002397 RID: 9111 RVA: 0x0007EA0D File Offset: 0x0007CC0D
		public override void OnBehaviorInitialize()
		{
			this._deploymentMissionController = base.Mission.GetMissionBehavior<DeploymentMissionController>();
		}

		// Token: 0x06002398 RID: 9112 RVA: 0x0007EA20 File Offset: 0x0007CC20
		public override void EarlyStart()
		{
		}

		// Token: 0x06002399 RID: 9113 RVA: 0x0007EA22 File Offset: 0x0007CC22
		public override void AfterStart()
		{
			this.PreviousMissionMode = base.Mission.Mode;
			base.Mission.SetMissionMode(MissionMode.Deployment, true);
		}

		// Token: 0x0600239A RID: 9114 RVA: 0x0007EA42 File Offset: 0x0007CC42
		public override void OnRemoveBehavior()
		{
			base.OnRemoveBehavior();
			base.Mission.SetMissionMode(this.PreviousMissionMode, false);
		}

		// Token: 0x0600239B RID: 9115 RVA: 0x0007EA5C File Offset: 0x0007CC5C
		public override void OnBattleSideDeployed(BattleSideEnum side)
		{
			if (side == base.Mission.PlayerTeam.Side)
			{
				Action onPlayerSideDeploymentReady = this.OnPlayerSideDeploymentReady;
				if (onPlayerSideDeploymentReady == null)
				{
					return;
				}
				onPlayerSideDeploymentReady();
				return;
			}
			else
			{
				Action onEnemySideDeploymentReady = this.OnEnemySideDeploymentReady;
				if (onEnemySideDeploymentReady == null)
				{
					return;
				}
				onEnemySideDeploymentReady();
				return;
			}
		}

		// Token: 0x0600239C RID: 9116
		public abstract void AutoDeployTeamUsingDeploymentPlan(Team playerTeam);

		// Token: 0x0600239D RID: 9117
		public abstract void ForceUpdateAllUnits();

		// Token: 0x0600239E RID: 9118 RVA: 0x0007EA92 File Offset: 0x0007CC92
		public virtual void FinishDeployment()
		{
			Mission mission = base.Mission ?? Mission.Current;
			this._deploymentMissionController.FinishDeployment();
			mission.IsTeleportingAgents = false;
		}

		// Token: 0x0600239F RID: 9119 RVA: 0x0007EAB4 File Offset: 0x0007CCB4
		public void InitializeDeploymentPoints()
		{
			if (!this._areDeploymentPointsInitialized)
			{
				foreach (DeploymentPoint deploymentPoint in base.Mission.ActiveMissionObjects.FindAllWithType<DeploymentPoint>())
				{
					deploymentPoint.Hide();
				}
				this._areDeploymentPointsInitialized = true;
			}
		}

		// Token: 0x060023A0 RID: 9120 RVA: 0x0007EB18 File Offset: 0x0007CD18
		internal static void OrderController_OnOrderIssued_Aux(OrderType orderType, MBReadOnlyList<Formation> appliedFormations, OrderController orderController = null, params object[] delegateParams)
		{
			DeploymentHandler.<>c__DisplayClass22_0 CS$<>8__locals1;
			CS$<>8__locals1.appliedFormations = appliedFormations;
			CS$<>8__locals1.orderController = orderController;
			bool flag = false;
			using (List<Formation>.Enumerator enumerator = CS$<>8__locals1.appliedFormations.GetEnumerator())
			{
				while (enumerator.MoveNext())
				{
					if (enumerator.Current.CountOfUnits > 0)
					{
						flag = true;
						break;
					}
				}
			}
			if (!flag)
			{
				return;
			}
			switch (orderType)
			{
			case OrderType.None:
				Debug.FailedAssert("false", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.MountAndBlade\\Missions\\MissionLogics\\DeploymentHandler.cs", "OrderController_OnOrderIssued_Aux", 152);
				return;
			case OrderType.Move:
			case OrderType.MoveToLineSegment:
			case OrderType.MoveToLineSegmentWithHorizontalLayout:
			case OrderType.FollowMe:
			case OrderType.FollowEntity:
			case OrderType.Advance:
			case OrderType.FallBack:
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForcePositioning|22_1(ref CS$<>8__locals1);
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref CS$<>8__locals1);
				return;
			case OrderType.Charge:
			case OrderType.ChargeWithTarget:
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForcePositioning|22_1(ref CS$<>8__locals1);
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref CS$<>8__locals1);
				return;
			case OrderType.StandYourGround:
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForcePositioning|22_1(ref CS$<>8__locals1);
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref CS$<>8__locals1);
				return;
			case OrderType.Retreat:
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForcePositioning|22_1(ref CS$<>8__locals1);
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref CS$<>8__locals1);
				return;
			case OrderType.LookAtEnemy:
			case OrderType.LookAtDirection:
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForcePositioning|22_1(ref CS$<>8__locals1);
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref CS$<>8__locals1);
				return;
			case OrderType.ArrangementLine:
			case OrderType.ArrangementCloseOrder:
			case OrderType.ArrangementLoose:
			case OrderType.ArrangementCircular:
			case OrderType.ArrangementSchiltron:
			case OrderType.ArrangementVee:
			case OrderType.ArrangementColumn:
			case OrderType.ArrangementScatter:
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref CS$<>8__locals1);
				return;
			case OrderType.FormCustom:
			case OrderType.FormDeep:
			case OrderType.FormWide:
			case OrderType.FormWider:
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref CS$<>8__locals1);
				return;
			case OrderType.CohesionHigh:
			case OrderType.CohesionMedium:
			case OrderType.CohesionLow:
			case OrderType.HoldFire:
			case OrderType.FireAtWill:
				return;
			case OrderType.Mount:
			case OrderType.Dismount:
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref CS$<>8__locals1);
				return;
			case OrderType.AIControlOn:
			case OrderType.AIControlOff:
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForcePositioning|22_1(ref CS$<>8__locals1);
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref CS$<>8__locals1);
				return;
			case OrderType.Transfer:
			case OrderType.Use:
			case OrderType.AttackEntity:
				DeploymentHandler.<OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref CS$<>8__locals1);
				return;
			case OrderType.PointDefence:
				Debug.FailedAssert("will be removed", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.MountAndBlade\\Missions\\MissionLogics\\DeploymentHandler.cs", "OrderController_OnOrderIssued_Aux", 224);
				return;
			}
			Debug.FailedAssert("false", "C:\\BuildAgent\\work\\mb3\\Source\\Bannerlord\\TaleWorlds.MountAndBlade\\Missions\\MissionLogics\\DeploymentHandler.cs", "OrderController_OnOrderIssued_Aux", 227);
		}

		// Token: 0x060023A1 RID: 9121 RVA: 0x0007ED00 File Offset: 0x0007CF00
		[CompilerGenerated]
		internal unsafe static void <OrderController_OnOrderIssued_Aux>g__ForceUpdateFormationParams|22_0(ref DeploymentHandler.<>c__DisplayClass22_0 A_0)
		{
			foreach (Formation formation in A_0.appliedFormations)
			{
				if (formation.CountOfUnits > 0 && (A_0.orderController == null || A_0.orderController.FormationUpdateEnabledAfterSetOrder))
				{
					bool flag = false;
					if (formation.IsPlayerTroopInFormation)
					{
						flag = (formation.GetReadonlyMovementOrderReference()->OrderEnum == MovementOrder.MovementOrderEnum.Follow);
					}
					formation.ApplyActionOnEachUnit(delegate(Agent agent)
					{
						agent.ForceUpdateCachedAndFormationValues(true, false);
					}, flag ? Mission.Current.MainAgent : null);
					formation.SetHasPendingUnitPositions(false);
				}
			}
		}

		// Token: 0x060023A2 RID: 9122 RVA: 0x0007EDCC File Offset: 0x0007CFCC
		[CompilerGenerated]
		internal unsafe static void <OrderController_OnOrderIssued_Aux>g__ForcePositioning|22_1(ref DeploymentHandler.<>c__DisplayClass22_0 A_0)
		{
			foreach (Formation formation in A_0.appliedFormations)
			{
				if (formation.CountOfUnits > 0)
				{
					Vec2 direction = formation.FacingOrder.GetDirection(formation, null);
					Formation formation2 = formation;
					MovementOrder movementOrder = *formation.GetReadonlyMovementOrderReference();
					formation2.SetPositioning(new WorldPosition?(movementOrder.CreateNewOrderWorldPositionMT(formation, WorldPosition.WorldPositionEnforcedCache.None)), new Vec2?(direction), null);
				}
			}
		}

		// Token: 0x04000DAE RID: 3502
		protected MissionMode PreviousMissionMode;

		// Token: 0x04000DAF RID: 3503
		protected readonly bool IsPlayerAttacker;

		// Token: 0x04000DB0 RID: 3504
		protected DeploymentMissionController _deploymentMissionController;

		// Token: 0x04000DB1 RID: 3505
		private bool _areDeploymentPointsInitialized;
	}
}
